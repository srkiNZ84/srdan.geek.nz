<!doctype html><html lang=en><head><title>GitLab CI workflow with Python Flask app · Home of Srđan Đukić
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://disqus.com; img-src 'self' https://www.gravatar.com https://referrer.disqus.com https://c.disquscdn.com https://cdn.viglink.com; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/ https://c.disquscdn.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://srdan-geek-nz.disqus.com https://c.disquscdn.com; prefetch-src 'self' https://c.disquscdn.com https://disqus.com; connect-src 'self' https://www.google-analytics.com https://links.services.disqus.com;"><meta name=author content="Srđan Đukić"><meta name=description content="An example of a GitLab CI workflow using a Python Flask web app"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="GitLab CI workflow with Python Flask app"><meta name=twitter:description content="An example of a GitLab CI workflow using a Python Flask web app"><meta property="og:url" content="https://srdan.geek.nz/posts/friday-15th-september-23/"><meta property="og:site_name" content="Home of Srđan Đukić"><meta property="og:title" content="GitLab CI workflow with Python Flask app"><meta property="og:description" content="An example of a GitLab CI workflow using a Python Flask web app"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-15T10:51:47+12:00"><meta property="article:modified_time" content="2023-09-15T10:51:47+12:00"><meta property="article:tag" content="Gitlab"><meta property="article:tag" content="Python"><meta property="article:tag" content="Flask"><meta property="article:tag" content="Gitlab Ci"><meta property="article:tag" content="Deployments"><meta property="article:tag" content="Gcp"><link rel=canonical href=https://srdan.geek.nz/posts/friday-15th-september-23/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.36f76aaf39a14ecf5c3a3c6250dcaf06c238b3d8365d17d646f95cb1874e852b.css integrity="sha256-NvdqrzmhTs9cOjxiUNyvBsI4s9g2XRfWRvlcsYdOhSs=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.131.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Home of Srđan Đukić
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://srdan.geek.nz/posts/friday-15th-september-23/>GitLab CI workflow with Python Flask app</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-09-15T10:51:47+12:00>September 15, 2023
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
5-minute read</span></div><div class=authors><i class="fa fa-user" aria-hidden=true></i>
<a href=/authors/sr%C4%91an-%C4%91uki%C4%87/>Srđan Đukić</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/gitlab/>Gitlab</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/python/>Python</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/flask/>Flask</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/gitlab-ci/>Gitlab Ci</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/deployments/>Deployments</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/gcp/>Gcp</a></span></div></div></header><div class=post-content><h1 id=gitlab-ci--workflow-with-python-flask-app>GitLab CI workflow with Python Flask app
<a class=heading-link href=#gitlab-ci--workflow-with-python-flask-app><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><h2 id=about>About
<a class=heading-link href=#about><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In this blog post we are going to learn about GitLab CI, specifically looking at Deploy/Release automation.</p><p>We will be using a simple <a href=https://flask.palletsprojects.com/en/2.3.x/>Python Flask</a> app to do this, deploying to
<a href=https://cloud.google.com/>Google Cloud</a>&rsquo;s <a href="https://cloud.google.com/run?hl=en">Cloud Run service</a>.</p><p>The post assumes that you have a <a href=https://gitlab.com/>GitLab</a> account (to store our code and run the CI), a <a href=https://cloud.google.com/>Google Cloud</a> account (to have somewhere to deploy our code to) and <a href=https://www.python.org/>Python</a> and <a href=https://www.docker.com/>Docker</a> installed locally.</p><p>The code for this blog post can be found here: <a href=https://gitlab.com/srkiNZ/flask-gcp-demo>https://gitlab.com/srkiNZ/flask-gcp-demo</a></p><h2 id=first-step---get-a-working-app>First step - get a working app
<a class=heading-link href=#first-step---get-a-working-app><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>As a first step, we are going to get a Python Flask app running locally (and also get a Docker container building
locally) to ensure that we have working code.</p><p>So, we first need to ensure that we have Python and pip installed if they are not already present.</p><p>Next, create a directory to work in and setup the virtual environment:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>mkdir flask-gcp-demo
</span></span><span style=display:flex><span>cd flask-gcp-demo
</span></span><span style=display:flex><span>python3 -m venv .
</span></span><span style=display:flex><span>source ./bin/activate
</span></span></code></pre></div><p>Once that is done we install the pre-requisites with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install flask gunicorn
</span></span></code></pre></div><p>and add the file &ldquo;main.py&rdquo; with the following contents:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>from flask import Flask
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app = Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.route(&#34;/&#34;)
</span></span><span style=display:flex><span>def hello_world():
</span></span><span style=display:flex><span>    &#34;&#34;&#34;Example Hello World route.&#34;&#34;&#34;
</span></span><span style=display:flex><span>    name = os.environ.get(&#34;NAME&#34;, &#34;World&#34;)
</span></span><span style=display:flex><span>    return f&#34;Hello {name}! Nice to meet you :-) again!&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>if __name__ == &#34;__main__&#34;:
</span></span><span style=display:flex><span>    app.run(debug=True, host=&#34;0.0.0.0&#34;, port=int(os.environ.get(&#34;PORT&#34;, 8080)))
</span></span></code></pre></div><p>We can then test the above works by running:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>python3 main.py
</span></span></code></pre></div><p>and then navigating to <a href=http://localhost:8080>http://localhost:8080/</a>.</p><p>If this is working, we can move onto the next step. If not, we will need to debug why it&rsquo;s not running.</p><p>Go ahead and stop the app running with Ctrl+C.</p><h2 id=second-step---put-the-app-into-a-container>Second step - Put the app into a container
<a class=heading-link href=#second-step---put-the-app-into-a-container><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>So, in order to put the app into a container, firstly we should put the requirements into a file. We can do this with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip freeze &gt; requirements.txt
</span></span></code></pre></div><p>This should result in a new &ldquo;requirements.txt&rdquo; file with the following contents:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Flask==3.0.0
</span></span><span style=display:flex><span>Werkzeug==3.0.1
</span></span><span style=display:flex><span>gunicorn==20.1.0
</span></span></code></pre></div><p>NOTE: The versions of packages might be different for your setup</p><p>Next, we will create a Dockerfile with the following contents:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>FROM python:3.11-slim
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Allow statements and log messages to immediately appear in the logs
</span></span><span style=display:flex><span>ENV PYTHONUNBUFFERED True
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Copy local code to the container image.
</span></span><span style=display:flex><span>ENV APP_HOME /app
</span></span><span style=display:flex><span>WORKDIR $APP_HOME
</span></span><span style=display:flex><span>COPY . ./
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Install production dependencies.
</span></span><span style=display:flex><span>RUN pip install --no-cache-dir -r requirements.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Run the web service on container startup. Here we use the gunicorn
</span></span><span style=display:flex><span># webserver, with one worker process and 8 threads.
</span></span><span style=display:flex><span># For environments with multiple CPU cores, increase the number of workers
</span></span><span style=display:flex><span># to be equal to the cores available.
</span></span><span style=display:flex><span># Timeout is set to 0 to disable the timeouts of the workers to allow Cloud Run to handle instance scaling.
</span></span><span style=display:flex><span>CMD exec gunicorn --bind :$PORT --workers 1 --threads 8 --timeout 0 main:app
</span></span></code></pre></div><p>Assuming that this build succeeds, we should have a Docker image with an ID output in the logs, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>=&gt; =&gt; writing image sha256:b7ea714e556f36a21ea0754fa9031a0ca318a0e9f8a22a504470da02c9f59308
</span></span></code></pre></div><p>we can then run our Docker container locally with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>docker run -e PORT=8080 -p8080:8080 b7ea714e556f36a21ea0754fa9031a0ca318a0e9f8a22a504470da02c9f59308
</span></span></code></pre></div><p>and should be able to again open up http://localhost:8080 to see our app running, this time serving our app from inside
a running Docker container.</p><h2 id=third-step---commit-our-code-to-gitlab-and-enable-ci>Third step - Commit our code to GitLab and enable CI
<a class=heading-link href=#third-step---commit-our-code-to-gitlab-and-enable-ci><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Once we have some running code, let&rsquo;s <a href=https://docs.gitlab.com/ee/user/project/>create a blank project in GitLab</a> (untick the &ldquo;Initialize repository with a README&rdquo; checkbox) and commit our code to it with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>git init --initial-branch=main
</span></span><span style=display:flex><span>git remote add origin git@gitlab.com:[YOUR_USERNAME_HERE]/[YOUR_PROJECT_NAME_HERE].git
</span></span><span style=display:flex><span>git add .
</span></span><span style=display:flex><span>git commit -m &#34;Initial commit&#34;
</span></span><span style=display:flex><span>git push --set-upstream origin main
</span></span></code></pre></div><p>Now that our code is safely in version control, we can create a <a href=https://en.wikipedia.org/wiki/Continuous_integration>continuous integration</a> (CI)
pipeline to build and deploy our application, in our case to Google Cloud&rsquo;s Cloud Run service.</p><p>For this step, we will be following the GitLab tutorial at: <a href=https://about.gitlab.com/blog/2023/08/21/how-to-secure-cloud-run-deployment-with-auto-devops/>https://about.gitlab.com/blog/2023/08/21/how-to-secure-cloud-run-deployment-with-auto-devops/</a></p><p>NOTE: We are assuming that the reader is familiar with GitLabCI and building simple pipelines</p><p>We first need to add the Service Account Key, Project ID and Service ID to the list of CI variables to make it available to our build. Once that is done, we can add the following to a file &ldquo;.gitlab-ci.yml&rdquo;:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>deploy-job:
</span></span><span style=display:flex><span>    stage: deploy
</span></span><span style=display:flex><span>    image: google/cloud-sdk:latest
</span></span><span style=display:flex><span>    script:
</span></span><span style=display:flex><span>        - <span style=font-weight:700>export</span> GOOGLE_CLOUD_CREDENTIALS=$(echo $BASE64_GOOGLE_CLOUD_CREDENTIALS | base64 -d)
</span></span><span style=display:flex><span>        - echo $GOOGLE_CLOUD_CREDENTIALS &gt; service-account-key.json 
</span></span><span style=display:flex><span>        - gcloud auth activate-service-account --key-file service-account-key.json 
</span></span><span style=display:flex><span>        - gcloud config set project $PROJECT_ID 
</span></span><span style=display:flex><span>        - gcloud auth configure-docker
</span></span><span style=display:flex><span>        - gcloud builds submit --tag gcr.io/$PROJECT_ID/$SERVICE_ID
</span></span><span style=display:flex><span>        - gcloud run deploy $SERVICE_ID --image gcr.io/$PROJECT_ID/$SERVICE_ID --region=australia-southeast2 --platform managed --allow-unauthenticated 
</span></span></code></pre></div><p>NOTE: Replace the region in the &ldquo;gcloud run deploy &mldr;&rdquo; command above with the region that you are deploying to.</p><p>If the deployment fails with the following error message:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Deployment failed
</span></span><span style=display:flex><span>ERROR: (gcloud.run.deploy) PERMISSION_DENIED: Permission &#39;iam.serviceaccounts.actAs&#39; denied on service account 30704999140-compute@developer.gserviceaccount.com (or it may not exist).
</span></span></code></pre></div><p>it is likely due to the Service Account that GitLab CI is using not having the &ldquo;Cloud Run Service Agent&rdquo; IAM Role (as per <a href=https://stackoverflow.com/questions/55788714/deploying-to-cloud-run-with-a-custom-service-account-failed-with-iam-serviceacco>this SO issue</a>).</p><p>If the deployment is successful, congratulations! We have just used GitLab CI to deploy our application to GCP&rsquo;s Cloud Run service!</p><p>In the next post, we will build on this work to set up separate environments to deploy to and explore GitLab CI&rsquo;s environment and automated deployment features.</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//srdan-geek-nz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2024
Srđan Đukić
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>